<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4" main_tree_to_execute="ProductAgent">
  <BehaviorTree ID="ProductAgent">
    <Sequence name="ProductAgentFlow">
      <Retry name="InitRetry" maxRetries="{config.RetryInit}" backoffMs="1000">
        <Fallback name="InitWithErrorLogging">
          <Sequence name="ProductAgentInitializationSequence">
            <ReadConfig name="LoadProductConfig" configPath="{config.Path}" />
            <SetBlackboardValue name="BindAgentId" Key="AgentId" Value="{config.Agent.AgentId}" />
            <SetBlackboardValue name="BindAgentRole" Key="AgentRole" Value="{config.Agent.Role}" />
            <SetBlackboardValue name="BindNamespace" Key="Namespace" Value="{config.Namespace}" />
            <ConnectToMessagingBroker
              name="ConnectMqtt"
              BrokerHost="{config.MQTT.Broker}"
              BrokerPort="{config.MQTT.Port}"
              TimeoutMs="10000" />
            <ReadShell name="LoadProductShell" AgentId="{config.Agent.AgentId}" ShellRepositoryEndpoint="{config.AAS.ShellRepositoryEndpoint}" />
            <LoadProductIdentificationSubmodel name="LoadProductIdentification" SubmodelRepositoryEndpoint="{config.AAS.SubmodelRepositoryEndpoint}" TargetIdShort="ProductIdentification" />
            <LoadBillOfMaterialSubmodel name="LoadBillOfMaterial" SubmodelRepositoryEndpoint="{config.AAS.SubmodelRepositoryEndpoint}" TargetIdShort="BillOfMaterial" />
            <LoadCapabilityDescriptionSubmodel name="LoadCapabilityDescription" SubmodelRepositoryEndpoint="{config.AAS.SubmodelRepositoryEndpoint}" />
            <SendProductSummaryLog name="PublishProductSummary" LogLevel="INFO" />
          </Sequence>
          <ForceFailure name="InitFailureHandler">
            <SendLogMessage name="InitFailureLog" LogLevel="ERROR" Message="ProductAgent initialization failed" Topic="{config.Agent.AgentId}/logs" />
          </ForceFailure>
        </Fallback>
      </Retry>

      <Fallback name="SelectPlanningMode">
        <Sequence name="ProcessChainMode">
          <CheckConfigFlag name="CheckProcessChainMode"
                           ConfigPath="Agent.RequestProcessChainOnly"
                           ExpectedValue="true"
                           DefaultValue="false" />
          <Fallback name="ReuseOrRequestProcessChain">
            <Sequence name="UseExistingProcessChain">
              <CheckProcessChainRequestPolicy name="CheckForceProcessChainRequest" ConfigFlagPath="Agent.ForceProcessChainRequest" />
              <LoadProcessChainFromShell name="LoadExistingProcessChain"
                                         ContextKey="ProcessChain.Result"
                                         SubmodelIdContextKey="ProcessChain.SubmodelId"
                                         SubmodelRepositoryEndpoint="{config.AAS.SubmodelRepositoryEndpoint}"
                                         TargetElementIdShort="ProcessChain" />
            </Sequence>
            <Sequence name="RequestNewProcessChain">
              <SendProcessChainRequest name="SendProcessChainRequest" />
              <!-- Expect negotiation reply: 'proposal' or 'refuseProposal' for the callForProposal pattern -->
              <WaitForMessage name="AwaitProcessChainResponse" ExpectedTypes="proposal,refuseProposal" ExpectedConversationId="{ConversationId}" ExpectedTopic="/{Namespace}/ProcessChain" TimeoutSeconds="30000" />
              <UploadSubmodel name="UploadProcessChain"
                             ContextKey="ProcessChain.Result"
                             SubmodelIdPrefix="processChain"
                             SubmodelRepositoryEndpoint="{config.AAS.SubmodelRepositoryEndpoint}"
                             ShellRepositoryEndpoint="{config.AAS.ShellRepositoryEndpoint}"
                             AddReferenceToShell="true" />
              <SetBlackboardValue name="RememberProcessChainSubmodelId"
                                  Key="ProcessChain.SubmodelId"
                                  Value="{Submodel.LastUploadedId}" />
            </Sequence>
          </Fallback>
        </Sequence>
        <Sequence name="ManufacturingSequenceMode">
          <CheckConfigFlag name="CheckManufacturingMode"
                           ConfigPath="Agent.RequestProcessChainOnly"
                           ExpectedValue="false"
                           DefaultValue="false" />
          <SendManufacturingRequest name="SendManufacturingRequest"
                                    Topic="/{Namespace}/ManufacturingSequenceRequest" />
          <WaitForMessage name="AwaitManufacturingSequenceResponse"
                          ExpectedTypes="proposal,refuseProposal"
                          ExpectedTopic="/{Namespace}/ManufacturingSequence"
                          ExpectedConversationId="{ManufacturingRequest.ConversationId}"
                          TimeoutSeconds="30000" />
          <UploadSubmodel name="UploadManufacturingSequence"
                          ContextKey="ManufacturingSequence.Result"
                          SubmodelIdShort="ManufacturingSequence"
                          SubmodelIdPrefix="manufacturingSequence"
                          SubmodelRepositoryEndpoint="{config.AAS.SubmodelRepositoryEndpoint}"
                          ShellRepositoryEndpoint="{config.AAS.ShellRepositoryEndpoint}"
                          AddReferenceToShell="true" />
          <SetBlackboardValue name="RememberManufacturingSequenceSubmodelId"
                              Key="ManufacturingSequence.SubmodelId"
                              Value="{Submodel.LastUploadedId}" />
        </Sequence>
      </Fallback>
    </Sequence>
  </BehaviorTree>

  <TreeNodesModel>
    <Action ID="ReadConfig">
      <input_port name="configPath" />
    </Action>
    <Action ID="ConnectToMessagingBroker">
      <input_port name="BrokerHost" />
      <input_port name="BrokerPort" />
      <input_port name="DefaultTopic" />
      <input_port name="TimeoutMs" />
      <input_port name="ClientId" />
    </Action>
    <Decorator ID="Retry">
      <input_port name="maxRetries" default="3" />
      <input_port name="backoffMs" default="100" />
      <input_port name="exponentialBackoff" default="true" />
    </Decorator>
    <Action ID="SetBlackboardValue">
      <input_port name="Key" />
      <input_port name="Value" />
      <input_port name="ValueType" default="string" />
    </Action>
    <Action ID="ReadShell">
      <input_port name="AgentId" />
      <input_port name="ShellRepositoryEndpoint" />
    </Action>
    <Action ID="LoadProductIdentificationSubmodel">
      <input_port name="SubmodelRepositoryEndpoint" />
      <input_port name="TargetIdShort" />
    </Action>
    <Action ID="LoadBillOfMaterialSubmodel">
      <input_port name="SubmodelRepositoryEndpoint" />
      <input_port name="TargetIdShort" />
    </Action>
    <Action ID="LoadProcessChainFromShell">
      <input_port name="ContextKey" />
      <input_port name="SubmodelIdContextKey" />
      <input_port name="SubmodelRepositoryEndpoint" />
      <input_port name="TargetElementIdShort" />
    </Action>
    <Action ID="LoadCapabilityDescriptionSubmodel">
      <input_port name="SubmodelRepositoryEndpoint" />
      <input_port name="TargetIdShort" />
      <input_port name="SemanticIdFilter" />
    </Action>
    <Action ID="SendLogMessage">
      <input_port name="LogLevel" />
      <input_port name="Message" />
      <input_port name="ModuleId" />
      <input_port name="Topic" />
    </Action>
    <Decorator ID="ForceFailure" />
    <Action ID="SendProcessChainRequest" />
    <Action ID="WaitForMessage">
      <input_port name="ExpectedType" />
      <input_port name="ExpectedTypes" />
      <input_port name="ExpectedSender" />
      <input_port name="ExpectedTopic" />
      <input_port name="TimeoutSeconds" />
      <input_port name="ExpectedConversationId" />
    </Action>
    <Action ID="SendProductSummaryLog">
      <input_port name="Topic" />
      <input_port name="LogLevel" default="INFO" />
    </Action>
    <Action ID="CheckProcessChainRequestPolicy">
      <input_port name="ConfigFlagPath" />
      <input_port name="DefaultForceRequest" />
    </Action>
    <Action ID="SendManufacturingRequest">
      <input_port name="Topic" />
      <input_port name="MessageType" />
    </Action>
    <Action ID="CheckConfigFlag">
      <input_port name="ConfigPath" />
      <input_port name="ExpectedValue" />
      <input_port name="DefaultValue" />
    </Action>
  </TreeNodesModel>
</root>
