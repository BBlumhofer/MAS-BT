<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4" main_tree_to_execute="DispatchingAgent">
  <BehaviorTree ID="DispatchingAgent">
    <Sequence name="DispatchingAgentRoot">
      <ReadConfig name="LoadConfig" configPath="{config.Path}" />
      <SetBlackboardValue name="BindAgentId" Key="AgentId" Value="{config.Agent.AgentId}" />
      <SetBlackboardValue name="BindAgentRole" Key="AgentRole" Value="{config.Agent.Role}" />
      <SetBlackboardValue name="BindNamespace" Key="Namespace" Value="{config.Namespace}" />

      <ConnectToMessagingBroker
        name="ConnectMqtt"
        BrokerHost="{config.MQTT.Broker}"
        BrokerPort="{config.MQTT.Port}"
        DefaultTopic="{config.MQTT.TopicPrefix}/dispatching"
        TimeoutMs="10000"
        ClientId="{config.Agent.AgentId}_Dispatching" />

      <InitializeAgentState name="InitDispatchState" Role="{config.Agent.Role}" />
      <SubscribeAgentTopics name="SubscribeTopics" Role="{config.Agent.Role}" />
      <RegisterAgent name="InitialRegistration" ParentAgent="{config.Namespace}" />

      <Parallel name="DispatchingLoops">
        <Repeat name="RegistrationLoop" num_cycles="-1">
          <Fallback name="RegOrWait">
            <Sequence name="HandleRegistration">
              <WaitForMessage name="WaitRegistration" ExpectedTypes="registerMessage,moduleRegistration" TimeoutSeconds="10" />
              <HandleRegistration name="HandleRegistration" />
              <RegisterAgent name="RegisterAfterRegistration" ParentAgent="{config.Namespace}" />
              <Wait name="RegIdle" DelayMs="10000" />
            </Sequence>
            <Wait name="RegBackoff" DelayMs="10000" />
          </Fallback>
        </Repeat>

        <Repeat name="InventoryLoop" num_cycles="-1">
          <Fallback name="InvOrWait">
            <Sequence name="HandleInventory">
              <WaitForMessage name="WaitInventory" ExpectedTypes="inventoryUpdate" TimeoutSeconds="5" />
              <HandleInventoryUpdate name="HandleInventoryUpdate" />
              <RegisterAgent name="RegisterAfterInventory" ParentAgent="{config.Namespace}" />
              <Wait name="InvIdle" DelayMs="200" />
            </Sequence>
            <Wait name="InvBackoff" DelayMs="200" />
          </Fallback>
        </Repeat>

        <Repeat name="ProcessChainLoop" num_cycles="-1">
          <Fallback name="ProcessChainOrIdle">
            <Sequence name="HandleProcessChain">
              <WaitForMessage name="AwaitProcessChain" ExpectedTypes="callForProposal" ExpectedTopic="/{Namespace}/ProcessChain" TimeoutSeconds="10" />
              <ParseProcessChainRequest name="ParseProcessChainRequest" />
              <Fallback name="CapabilityMatchmaking">
                <Sequence name="CapabilitiesAvailable">
                  <CheckForCapabilitiesInNamespace name="CheckForCapabilitiesInNamespace" />
                  <DispatchCapabilityRequests name="DispatchCapabilityRequests" />
                  <CollectCapabilityOffer name="CollectCapabilityOffer" />
                  <BuildProcessChainResponse name="BuildProcessChainResponse" />
                  <SendProcessChainResponse name="SendProcessChainResponse" />
                </Sequence>
                <Sequence name="CapabilitiesMissing">
                  <SendProcessChainResponse name="SendProcessChainRefusal" />
                </Sequence>
              </Fallback>
              <Wait name="ProcessChainIdle" DelayMs="200" />
            </Sequence>
            <Wait name="ProcessChainBackoff" DelayMs="200" />
          </Fallback>
        </Repeat>

        <Repeat name="ManufacturingSequenceLoop" num_cycles="-1">
          <Fallback name="MfgSeqOrIdle">
            <Sequence name="HandleMfgSeq">
              <WaitForMessage name="AwaitMfgSeq" ExpectedTypes="requestManufacturingSequence,manufacturingSequenceRequest" TimeoutSeconds="10" />
              <HandleManufacturingSequenceRequest name="HandleManufacturingSequenceRequest" />
              <Wait name="MfgIdle" DelayMs="300" />
            </Sequence>
            <Wait name="MfgBackoff" DelayMs="300" />
          </Fallback>
        </Repeat>

        <Repeat name="BookStepLoop" num_cycles="-1">
          <Fallback name="BookStepOrIdle">
            <Sequence name="HandleBookStep">
              <WaitForMessage name="AwaitBookStep" ExpectedTypes="bookStep" TimeoutSeconds="10" />
              <HandleBookStepRequest name="HandleBookStepRequest" />
              <Wait name="BookIdle" DelayMs="300" />
            </Sequence>
            <Wait name="BookBackoff" DelayMs="300" />
          </Fallback>
        </Repeat>

        <Repeat name="TransportPlanLoop" num_cycles="-1">
          <Fallback name="TransportOrIdle">
            <Sequence name="HandleTransportPlan">
              <WaitForMessage name="AwaitTransportPlan" ExpectedTypes="requestTransportPlan,transportRequest" TimeoutSeconds="10" />
              <HandleTransportPlanRequest name="HandleTransportPlanRequest" />
              <Wait name="TransportIdle" DelayMs="300" />
            </Sequence>
            <Wait name="TransportBackoff" DelayMs="300" />
          </Fallback>
        </Repeat>
        
        <Repeat name="RegistrationHeartbeat" num_cycles="-1">
          <Sequence name="RegistrationBeat">
            <RegisterAgent name="RegisterDispatchingHeartbeat" ParentAgent="{config.Namespace}" />
            <PublishAgentState name="PublishDispatchingState" PublishIntervalSeconds="30" Role="{config.Agent.Role}" />
            <Wait name="PublishIdle" DelayMs="{config.Agent.RegistrationIntervalMs}" />
          </Sequence>
        </Repeat>
      </Parallel>
    </Sequence>
  </BehaviorTree>

  <TreeNodesModel>
    <Action ID="ReadConfig">
      <input_port name="configPath" />
    </Action>
    <Action ID="SetBlackboardValue">
      <input_port name="Key" />
      <input_port name="Value" />
      <input_port name="ValueType" default="string" />
    </Action>
    <Action ID="ConnectToMessagingBroker">
      <input_port name="BrokerHost" />
      <input_port name="BrokerPort" />
      <input_port name="DefaultTopic" />
      <input_port name="TimeoutMs" />
      <input_port name="ClientId" />
    </Action>
    <Action ID="InitializeAgentState">
      <input_port name="Role" />
    </Action>
    <Action ID="SubscribeAgentTopics">
      <input_port name="Role" />
      <input_port name="TopicPrefix" />
    </Action>
    <Action ID="RegisterAgent">
      <input_port name="ParentAgent" />
      <input_port name="Namespace" />
    </Action>
    <Action ID="WaitForMessage">
      <input_port name="ExpectedType" />
      <input_port name="ExpectedTypes" />
      <input_port name="ExpectedSender" />
      <input_port name="ExpectedTopic" />
      <input_port name="TimeoutSeconds" />
      <input_port name="ExpectedConversationId" />
    </Action>
    <Action ID="HandleRegistration" />
    <Action ID="HandleInventoryUpdate" />
    <Action ID="ParseProcessChainRequest" />
    <Action ID="CheckForCapabilitiesInNamespace" />
    <Action ID="DispatchCapabilityRequests" />
    <Action ID="CollectCapabilityOffer" />
    <Action ID="BuildProcessChainResponse" />
    <Action ID="SendProcessChainResponse" />
    <Action ID="HandleManufacturingSequenceRequest" />
    <Action ID="HandleBookStepRequest" />
    <Action ID="HandleTransportPlanRequest" />
    <Action ID="Wait">
      <input_port name="DelayMs" default="1000" />
    </Action>
    <Action ID="PublishAgentState">
      <input_port name="PublishIntervalSeconds" default="30" />
      <input_port name="Role" />
    </Action>
  </TreeNodesModel>
</root>
