<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4" main_tree_to_execute="ModuleInitialization">
  <BehaviorTree ID="ModuleInitialization">
    <Sequence name="InitializationSequence">
      
      <!-- ==================== SCHRITT 1: MQTT BROKER VERBINDUNG ==================== -->
      <RetryUntilSuccess name="MqttConnectRetry" numAttempts="-1" delayMs="5000">
        <Sequence name="MqttConnectSequence">
          <ConnectToMessagingBroker 
            name="ConnectMqtt"
            BrokerHost="localhost"
            BrokerPort="1883"
            DefaultTopic="factory/agents/messages"
            TimeoutMs="10000" />
        </Sequence>
      </RetryUntilSuccess>
      
      <!-- ==================== SCHRITT 2: CONFIG ALS MQTT LOG SENDEN ==================== -->
      <Sequence name="SendConfigSequence">
        <SendConfigAsLog name="SendConfig" />
      </Sequence>
      
      <!-- ==================== SCHRITT 3: OPC UA VERBINDUNG MIT RETRY ==================== -->
      <RetryUntilSuccess name="OpcUaConnectRetry" numAttempts="-1" delayMs="3000">
        <Sequence name="OpcUaConnectSequence">
          <ConnectToModule 
            name="ConnectOPC"
            Endpoint="{config.OPCUA.Endpoint}"
            TimeoutMs="30000" />
        </Sequence>
      </RetryUntilSuccess>
      
      <!-- ==================== SCHRITT 4: MODUL LOCKEN MIT RETRY + ÜBERWACHUNG ==================== -->
      <RetryUntilSuccess name="LockRetry" numAttempts="-1" delayMs="2000">
        <Sequence name="LockAndVerifySequence">
          <Fallback name="LockOrWait">
            <Sequence name="TryLockSequence">
              <LockResource 
                name="LockModule"
                ModuleName="ScrewingStation"
                ResourceId="{config.Agent.ModuleId}"
                TimeoutSeconds="30" />
              
              <Wait name="WaitAfterLock" DelayMs="500" />
              
              <CheckLockStatus 
                name="VerifyLock"
                ModuleName="ScrewingStation" />
            </Sequence>
            
            <Sequence name="LockFailedSequence">
              <!-- Always fail to trigger retry -->
              <BlackboardCondition 
                name="AlwaysFail"
                Key="__never_exists__" 
                ExpectedValue="true" />
            </Sequence>
          </Fallback>
        </Sequence>
      </RetryUntilSuccess>
      
      <!-- ==================== SCHRITT 5: STARTUP SKILL MIT LOCK-ÜBERWACHUNG ==================== -->
      <Sequence name="StartupWithLockMonitoring">
        <Sequence name="PreStartupLockCheck">
          <CheckLockStatus 
            name="CheckLockBeforeStartup"
            ModuleName="ScrewingStation" />
        </Sequence>
        
        <Sequence name="StartupSequence">
          <ExecuteSkill 
            name="ExecuteStartup"
            ModuleName="ScrewingStation"
            SkillName="StartupSkill"
            WaitForCompletion="false"
            TimeoutSeconds="60"
            ResetBeforeIfHalted="true" />
        </Sequence>
      </Sequence>
      
      <!-- ==================== SCHRITT 6: STORAGE AUSLESEN ==================== -->
      <Sequence name="ReadStorageSequence">
        <ReadStorage 
          name="ReadModuleStorage"
          ModuleName="ScrewingStation" />
      </Sequence>
      
    </Sequence>
  </BehaviorTree>
  
  <!-- TreeNodesModel for Groot2 Editor -->
  <TreeNodesModel>
    <Action ID="ConnectToMessagingBroker">
      <input_port name="BrokerHost"/>
      <input_port name="BrokerPort"/>
      <input_port name="DefaultTopic"/>
      <input_port name="TimeoutMs"/>
    </Action>
    <Action ID="SendConfigAsLog"/>
    <Action ID="ConnectToModule">
      <input_port name="Endpoint"/>
      <input_port name="TimeoutMs"/>
    </Action>
    <Action ID="LockResource">
      <input_port name="ModuleName"/>
      <input_port name="ResourceId"/>
      <input_port name="TimeoutSeconds"/>
    </Action>
    <Action ID="Wait">
      <input_port name="DelayMs"/>
    </Action>
    <Condition ID="CheckLockStatus">
      <input_port name="ModuleName"/>
    </Condition>
    <Action ID="ExecuteSkill">
      <input_port name="ModuleName"/>
      <input_port name="SkillName"/>
      <input_port name="WaitForCompletion"/>
      <input_port name="TimeoutSeconds"/>
      <input_port name="ResetBeforeIfHalted"/>
    </Action>
    <Action ID="ReadStorage">
      <input_port name="ModuleName"/>
    </Action>
    <Condition ID="BlackboardCondition">
      <input_port name="Key"/>
      <input_port name="ExpectedValue"/>
    </Condition>
  </TreeNodesModel>
</root>
