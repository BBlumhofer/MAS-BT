<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4" main_tree_to_execute="ModuleInitAndExecuteSkill">
  <BehaviorTree ID="ModuleInitAndExecuteSkill">
    <Sequence name="InitAndExecuteSequence">
      
      <!-- ==================== SCHRITT 1: MQTT BROKER VERBINDUNG ==================== -->
      <RetryUntilSuccess name="MqttConnectRetry" numAttempts="-1" delayMs="5000">
        <ConnectToMessagingBroker 
          name="ConnectMqtt"
          BrokerHost="localhost"
          BrokerPort="1883"
          DefaultTopic="factory/agents/messages"
          TimeoutMs="10000" />
      </RetryUntilSuccess>
      
      <!-- ==================== SCHRITT 2: CONFIG ALS MQTT LOG SENDEN ==================== -->
      <SendConfigAsLog name="SendConfig" />
      
      <!-- ==================== SCHRITT 3: OPC UA VERBINDUNG MIT RETRY ==================== -->
      <RetryUntilSuccess name="OpcUaConnectRetry" numAttempts="-1" delayMs="3000">
        <ConnectToModule 
          name="ConnectOPC"
          Endpoint="{config.OPCUA.Endpoint}"
          TimeoutMs="30000" />
      </RetryUntilSuccess>

      <!-- Storage MQTT OnChange aktivieren -->
      <EnableStorageChangeMqtt name="EnableStorageOnChange" />
      
      <!-- ==================== SCHRITT 4: INITIAL LOCK + STARTUP ==================== -->
      <Sequence name="InitialLockAndStartup">
        <LockResource
          name="InitialLock"
          ModuleName="{config.Agent.ModuleId}"
          ResourceId="{config.Agent.ModuleId}"
          TimeoutSeconds="30" />

        <CheckLockedState
          name="VerifyInitialLock"
          ModuleName="{config.Agent.ModuleId}"
          ExpectLocked="true" />

        <ExecuteSkill
          name="ExecuteStartup"
          ModuleName="{config.Agent.ModuleId}"
          SkillName="Startup"
          WaitForCompletion="false"
          TimeoutSeconds="60"
          ResetBeforeIfHalted="true" />

        <WaitForSkillState
          name="WaitForStartupRunning"
          ModuleName="{config.Agent.ModuleId}"
          SkillName="Startup"
          TargetState="Running"
          TimeoutSeconds="60"
          PollIntervalMs="500"
          SendErrorOnTimeout="true" />
      </Sequence>
      
      <!-- ==================== SCHRITT 5: STORAGE AUSLESEN ==================== -->
      <ReadStorage 
        name="ReadModuleStorage"
        ModuleName="{config.Agent.ModuleId}" />
      
      <!-- ==================== SCHRITT 6: SCREW SKILL MIT PARALLEL MONITORING ==================== -->
      <Parallel name="ExecuteScrewWithMonitoring" policy="ParallelAll">
        
        <!-- Main Execution Branch -->
        <Sequence name="MainExecutionBranch">
          <ExecuteSkill 
            name="ExecuteScrew"
            ModuleName="{config.Agent.ModuleId}"
            SkillName="Store"
            Parameters="ProductId=HelloWorld"
            TimeoutSeconds="120"
            ResetBeforeIfHalted="true" />
        </Sequence>
        
        <!-- Continuous Health Monitor Branch -->
        <Repeat name="ContinuousHealthMonitor" num_cycles="-1">
          <Sequence name="HealthCheckCycle">
            
            <!-- Health Checks mit Recovery Fallback -->
            <Fallback name="HealthCheckWithRecovery">
              
              <!-- Try Health Checks -->
              <Sequence name="HealthChecks">
                <CheckLockStatus 
                  name="CheckLock"
                  ModuleName="{config.Agent.ModuleId}" />
                
                <CheckStartupSkillStatus 
                  name="CheckStartup"
                  ModuleName="{config.Agent.ModuleId}" />
                
                <CheckErrorState 
                  name="CheckErrors"
                  ModuleName="{config.Agent.ModuleId}" />
              </Sequence>
              
              <!-- If Health Check Failed â†’ Trigger Recovery -->
                <Sequence name="AutoRecovery">
                <UnlockResource name="AutoUnlock" ModuleName="{config.Agent.ModuleId}" ResourceId="{config.Agent.ModuleId}" />
                <Wait name="WaitAfterUnlock" DelayMs="1000" />
                <LockResource name="AutoRelock" ModuleName="{config.Agent.ModuleId}" ResourceId="{config.Agent.ModuleId}" TimeoutSeconds="10" />
              </Sequence>
              
            </Fallback>
            
            <!-- Wait before next check -->
            <Wait name="WaitBetweenChecks" DelayMs="2000" />
            
          </Sequence>
        </Repeat>
        
      </Parallel>
      
    </Sequence>
  </BehaviorTree>
  
  <!-- TreeNodesModel for Groot2 Editor -->
  <TreeNodesModel>
    <Action ID="ConnectToMessagingBroker">
      <input_port name="BrokerHost"/>
      <input_port name="BrokerPort"/>
      <input_port name="DefaultTopic"/>
      <input_port name="TimeoutMs"/>
    </Action>
    <Action ID="SendConfigAsLog"/>
    <Action ID="ConnectToModule">
      <input_port name="Endpoint"/>
      <input_port name="TimeoutMs"/>
    </Action>
    <Action ID="EnsureModuleLocked">
      <input_port name="ModuleName"/>
      <input_port name="ResourceId"/>
      <input_port name="MaxRetries"/>
      <input_port name="RetryDelayMs"/>
    </Action>
    <Action ID="EnsureStartupRunning">
      <input_port name="ModuleName"/>
      <input_port name="TimeoutSeconds"/>
    </Action>
    <Action ID="Wait">
      <input_port name="DelayMs"/>
    </Action>
    <Condition ID="CheckLockStatus">
      <input_port name="ModuleName"/>
    </Condition>
    <Condition ID="CheckStartupSkillStatus">
      <input_port name="ModuleName"/>
    </Condition>
    <Condition ID="CheckErrorState">
      <input_port name="ModuleName"/>
    </Condition>
    <Action ID="RecoverySequence">
      <input_port name="ModuleName"/>
      <input_port name="ResourceId"/>
    </Action>
    <Action ID="ExecuteSkill">
      <input_port name="ModuleName"/>
      <input_port name="SkillName"/>
      <input_port name="Parameters"/>
      <input_port name="WaitForCompletion"/>
      <input_port name="TimeoutSeconds"/>
      <input_port name="ResetAfterCompletion" default="true"/>
      <input_port name="ResetBeforeIfHalted"/>
    </Action>
    <Action ID="ReadStorage">
      <input_port name="ModuleName"/>
    </Action>
    <Action ID="EnableStorageChangeMqtt"/>
  </TreeNodesModel>
</root>
