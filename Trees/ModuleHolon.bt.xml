<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4" main_tree_to_execute="ModuleHolon">
  <BehaviorTree ID="ModuleHolon">
    <Sequence name="ModuleHolonRoot">
      <ReadConfig name="LoadConfig" configPath="{config.Path}" />
      <SetBlackboardValue name="BindAgentId" Key="AgentId" Value="{config.Agent.AgentId}" />
      <SetBlackboardValue name="BindAgentRole" Key="AgentRole" Value="{config.Agent.Role}" />
      <SetBlackboardValue name="BindModuleId" Key="ModuleId" Value="{config.Agent.ModuleId}" />
      <SetBlackboardValue name="BindNamespace" Key="Namespace" Value="{config.Namespace}" />

      <ConnectToMessagingBroker
        name="ConnectMqtt"
        BrokerHost="{config.MQTT.Broker}"
        BrokerPort="{config.MQTT.Port}"
        DefaultTopic="/{config.Namespace}/{config.Agent.ModuleName}"
        TimeoutMs="10000"
        ClientId="{config.Agent.AgentId}_ModuleHolon" />

      <SubscribeAgentTopics name="SubscribeTopics" Role="{config.Agent.Role}" />
      <SpawnSubHolons name="SpawnSubHolons" SubHolonIds="{config.SubHolons}" />
        <!-- ExpectedAgents is intentionally omitted: config.SubHolons contains config filenames, not runtime AgentIds -->
        <WaitForRegistration name="WaitSubHolons" TimeoutSeconds="15" />
      <RegisterAgent name="InitialRegistration" ParentAgent="DispatchingAgent_{config.Namespace}" />

      <Parallel name="HolonLoops">
        <Repeat name="OfferLoop" num_cycles="-1">
          <Fallback name="OfferOrIdle">
            <Sequence name="HandleOffer">
              <ForwardCapabilityRequests name="ForwardOffer" TargetTopicTemplate="/{Namespace}/{ModuleId}/PlanningAgent/OfferRequest" />
              <WaitForInternalResponse name="AwaitOfferResp" TimeoutSeconds="10" />
              <ReplyToDispatcher name="ReplyOffer" ResponseTopicTemplate="/{Namespace}/DispatchingAgent/Offers" />
              <Wait name="OfferIdle" DelayMs="150" />
            </Sequence>
            <Wait name="OfferBackoff" DelayMs="200" />
          </Fallback>
        </Repeat>

        <Repeat name="ScheduleLoop" num_cycles="-1">
          <Fallback name="ScheduleOrIdle">
            <Sequence name="HandleSchedule">
              <WaitForMessage name="AwaitSchedule" ExpectedTypes="scheduleAction" ExpectedTopic="/{Namespace}/{ModuleId}/ScheduleAction" TimeoutSeconds="10" />
              <ForwardToInternal name="ForwardSchedule" TargetTopic="/{Namespace}/{ModuleId}/PlanningAgent/ScheduleAction" />
              <WaitForInternalResponse name="AwaitScheduleResp" TimeoutSeconds="10" />
              <ReplyToDispatcher name="ReplySchedule" ResponseTopicTemplate="/{Namespace}/{ModuleId}/BookingConfirmation" />
              <Wait name="ScheduleIdle" DelayMs="200" />
            </Sequence>
            <Wait name="ScheduleBackoff" DelayMs="200" />
          </Fallback>
        </Repeat>

        <Repeat name="TransportLoop" num_cycles="-1">
          <Fallback name="TransportOrIdle">
            <Sequence name="HandleTransport">
              <WaitForMessage name="AwaitTransport" ExpectedTypes="transportRequest,requestTransportPlan" ExpectedTopic="/{Namespace}/{ModuleId}/TransportPlan" TimeoutSeconds="10" />
              <ForwardToInternal name="ForwardTransport" TargetTopic="/{Namespace}/{ModuleId}/PlanningAgent/TransportRequest" />
              <WaitForInternalResponse name="AwaitTransportResp" TimeoutSeconds="10" />
              <ReplyToDispatcher name="ReplyTransport" ResponseTopicTemplate="/{Namespace}/{ModuleId}/TransportPlan" />
              <Wait name="TransportIdle" DelayMs="200" />
            </Sequence>
            <Wait name="TransportBackoff" DelayMs="200" />
          </Fallback>
        </Repeat>

        <Repeat name="HeartbeatLoop" num_cycles="-1">
          <Sequence name="Heartbeat">
            <ReadCachedSnapshots name="LoadLastSnapshots" />
            <RegisterAgent name="RefreshRegistration" ParentAgent="DispatchingAgent_{config.Namespace}" />
            <Wait name="HeartbeatWait" DelayMs="{config.Agent.RegistrationIntervalMs}" />
          </Sequence>
        </Repeat>
      </Parallel>
    </Sequence>
  </BehaviorTree>

  <TreeNodesModel>
    <Action ID="ReadConfig">
      <input_port name="configPath" />
    </Action>
    <Action ID="SetBlackboardValue">
      <input_port name="Key" />
      <input_port name="Value" />
      <input_port name="ValueType" default="string" />
    </Action>
    <Action ID="ConnectToMessagingBroker">
      <input_port name="BrokerHost" />
      <input_port name="BrokerPort" />
      <input_port name="DefaultTopic" />
      <input_port name="TimeoutMs" />
      <input_port name="ClientId" />
    </Action>
    <Action ID="SubscribeAgentTopics">
      <input_port name="Role" />
      <input_port name="TopicPrefix" />
    </Action>
    <Action ID="SpawnSubHolons">
      <input_port name="SubHolonIds" />
    </Action>
    <Action ID="WaitForRegistration">
      <input_port name="ExpectedAgents" />
      <input_port name="ExpectedCount" default="0" />
      <input_port name="TimeoutSeconds" default="20" />
    </Action>
    <Action ID="RegisterAgent">
      <input_port name="ParentAgent" />
      <input_port name="Namespace" />
    </Action>
    <Action ID="WaitForMessage">
      <input_port name="ExpectedType" />
      <input_port name="ExpectedTypes" />
      <input_port name="ExpectedSender" />
      <input_port name="ExpectedTopic" />
      <input_port name="TimeoutSeconds" />
      <input_port name="ExpectedConversationId" />
    </Action>
    <Action ID="ForwardCapabilityRequests">
      <input_port name="TargetTopicTemplate" />
      <input_port name="ExpectedSenderRole" />
    </Action>
    <Action ID="ForwardToInternal">
      <input_port name="TargetTopic" />
    </Action>
    <Action ID="WaitForInternalResponse">
      <input_port name="TimeoutSeconds" default="10" />
    </Action>
    <Action ID="ReplyToDispatcher">
      <input_port name="ResponseTopicTemplate" />
    </Action>
    <Action ID="Wait">
      <input_port name="DelayMs" default="1000" />
    </Action>
  </TreeNodesModel>
</root>
