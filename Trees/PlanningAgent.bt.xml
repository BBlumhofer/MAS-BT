<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4" main_tree_to_execute="PlanningAgent">
  <BehaviorTree ID="PlanningAgent">
    <Sequence name="PlanningAgentRoot">
      <ReadConfig name="LoadConfig" configPath="{config.Path}" />
      <InitNeo4j name="InitNeo4j" />
      <ConnectToMessagingBroker name="ConnectMqtt" BrokerHost="{config.MQTT.Broker}" BrokerPort="{config.MQTT.Port}" DefaultTopic="factory/agents/messages" TimeoutMs="10000" ClientId="{config.Agent.AgentId}_{config.Agent.Role}" />
      <SetBlackboardValue name="SetPlanningRole" Key="AgentRole" Value="{config.Agent.Role}" />
      <SetBlackboardValue name="SetPlanningId" Key="AgentId" Value="{config.Agent.AgentId}" />
      <SetBlackboardValue name="BindNamespace" Key="Namespace" Value="{config.Namespace}" />
      <SetBlackboardValue name="BindModuleId" Key="ModuleId" Value="{config.Agent.ModuleId}" />
      <Fallback name="LoadModuleShell">
        <ReadShell name="LoadModuleShellByName" AgentId="{config.Agent.ModuleName}" ShellRepositoryEndpoint="{config.AAS.ShellRepositoryEndpoint}" />
        <ReadShell name="LoadModuleShellById" AgentId="{config.Agent.ModuleId}" ShellRepositoryEndpoint="{config.AAS.ShellRepositoryEndpoint}" />
      </Fallback>
      <LoadCapabilityDescriptionSubmodel name="LoadCapabilityDescription" SubmodelRepositoryEndpoint="{config.AAS.SubmodelRepositoryEndpoint}" />
      <ExtractCapabilityNames name="ExtractCapabilities" SourceKey="CapabilityDescriptionSubmodel" TargetKey="Capabilities" />
      <PublishCapabilities name="PublishCapabilities" />
      <SubscribeAgentTopics name="SubscribeTopics" Role="{config.Agent.Role}" />
      <RegisterAgent name="RegisterPlanning" ParentAgent="{config.Agent.ModuleId}" />
      <SyncAgentToNeo4j name="SyncPlanningToGraph" />
      
      <Parallel name="PlanningParallel">
        <Repeat name="RegistrationHeartbeat" num_cycles="-1">
          <Sequence name="RegistrationBeat">
            <RegisterAgent name="RegisterPlanningHeartbeat" ParentAgent="{config.Agent.ModuleId}" />
            <SyncAgentToNeo4j name="SyncPlanningHeartbeat" />
            <Wait name="RegistrationWait" DelayMs="5000" />
          </Sequence>
        </Repeat>
        <Repeat name="CapabilityOfferLoop" num_cycles="-1">
          <Fallback name="OfferOrIdle">
            <Sequence name="AwaitThenRespondOrRefuse">
              <WaitForMessage name="AwaitCapabilityRequest" ExpectedTypes="callForProposal,callForProposal/ProcessChain,callForProposal/ManufacturingSequence" ExpectedTopic="/{Namespace}/{ModuleId}/PlanningAgent/OfferRequest" TimeoutSeconds="10" />
              <Fallback name="RespondOrRefuseAfterMessage">
                <Sequence name="RespondToCapabilityRequest">
                  <ParseCapabilityRequest name="ParseCapabilityRequest" />
                  <CapabilityMatchmaking name="ExecuteCapabilityMatchmaking" RequiredCapability="{RequiredCapability}" />
                  <CheckConstraints name="CheckConstraints" />
                  <RequestTransport name="RequestTransport" FromStation="{ModuleId}" ToStation="{TransportTarget}" />
                  <EvaluateRequestTransportResponse name="EvaluateTransportResponse" />
                  <FeasibilityCheck name="FeasibilityCheck" />
                  <PlanCapabilityOffer name="PlanCapabilityOffer" />
                  <SendCapabilityOffer name="SendCapabilityOffer" />
                  <Wait name="OfferCooldown" DelayMs="200" />
                </Sequence>
                <Sequence name="SendCapabilityRefusal">
                  <SendPlanningRefusal name="SendPlanningRefusal" ReceiverId="{RequesterId}" />
                  <Wait name="RefusalCooldown" DelayMs="500" />
                </Sequence>
              </Fallback>
            </Sequence>
            <Wait name="CapabilityIdle" DelayMs="200" />
          </Fallback>
        </Repeat>

        <Repeat name="OfferResponseLoop" num_cycles="-1">
          <Sequence name="OfferResponseSequence">
            <ReceiveOfferMessage name="ReceiveOfferMessage" />
            <AwaitOfferDecision name="AwaitOfferDecision" TimeoutMs="2000" />
            <ApplyOfferDecision name="ApplyOfferDecision" />
          </Sequence>
        </Repeat>

        <Repeat name="DispatchLoop" num_cycles="-1">
          <Fallback name="DispatchOrIdle">
            <Sequence name="DispatchIfReady">
              <SelectSchedulableAction name="SelectSchedulableAction" LeadTimeSeconds="0" />
              <SendSkillRequest name="SendSkillRequest" ModuleId="{config.Agent.ModuleName}" />
              <AwaitSkillResponse name="AwaitSkillResponse" ModuleId="{config.Agent.ModuleName}" TimeoutMs="10000" />
              <ApplySkillResponse name="ApplySkillResponse" />
              <Wait name="DispatchThrottle" DelayMs="200" />
            </Sequence>
            <Wait name="IdleWait" DelayMs="500" />
          </Fallback>
        </Repeat>
      </Parallel>
    </Sequence>
  </BehaviorTree>

  <TreeNodesModel>
    <Decorator ID="RetryUntilSuccess">
      <input_port name="numAttempts" default="-1"/>
      <input_port name="delayMs" default="1000"/>
    </Decorator>
    <Action ID="ReadConfig">
      <input_port name="configPath" />
    </Action>
    <Action ID="InitNeo4j" />
    <Action ID="ReadShell">
      <input_port name="AgentId" />
      <input_port name="ShellRepositoryEndpoint" />
    </Action>
    <Action ID="LoadCapabilityDescriptionSubmodel">
      <input_port name="SubmodelRepositoryEndpoint" />
      <input_port name="TargetIdShort" />
      <input_port name="SemanticIdFilter" />
    </Action>
    <Action ID="ExtractCapabilityNames">
      <input_port name="SourceKey" />
      <input_port name="TargetKey" />
      <input_port name="FailOnMissing" default="false" />
    </Action>
    <Action ID="PublishCapabilities">
      <input_port name="Namespace" />
      <input_port name="ModuleId" />
      <input_port name="SourceKey" />
    </Action>
    <Action ID="ConnectToMessagingBroker">
      <input_port name="BrokerHost"/>
      <input_port name="BrokerPort"/>
      <input_port name="DefaultTopic"/>
      <input_port name="TimeoutMs"/>
      <input_port name="ClientId"/>
    </Action>
    <Action ID="SubscribeAgentTopics">
      <input_port name="Role" />
      <input_port name="TopicPrefix" />
    </Action>
    <Action ID="SetBlackboardValue">
      <input_port name="Key" />
      <input_port name="Value" />
      <input_port name="ValueType" default="string" />
    </Action>
    <Action ID="RegisterAgent">
      <input_port name="ParentAgent" />
      <input_port name="Namespace" />
    </Action>
    <!-- LoadProductionPlan removed for PlanningAgent: plan should be provided by external planner -->
    <Action ID="SelectNextAction"/>
    <Action ID="SendSkillRequest">
      <input_port name="ModuleId"/>
    </Action>
    <Action ID="CapabilityMatchmaking">
      <input_port name="RequiredCapability"/>
    </Action>
    <Action ID="CheckConstraints"/>
    <Action ID="ParseCapabilityRequest" />
    <Action ID="SendPlanningRefusal">
      <input_port name="ReceiverId" />
      <input_port name="Reason" />
    </Action>
    <Action ID="FeasibilityCheck"/>
    <Action ID="PlanCapabilityOffer" />
    <Action ID="SendCapabilityOffer" />
    <Action ID="ReceiveOfferMessage"/>
    <Action ID="RequestTransport">
      <input_port name="FromStation"/>
      <input_port name="ToStation"/>
    </Action>
    <Action ID="EvaluateRequestTransportResponse"/>
    <Action ID="CheckScheduleFeasibility"/>
    <Action ID="AwaitOfferDecision">
      <input_port name="TimeoutMs" default="2000"/>
    </Action>
    <Action ID="ApplyOfferDecision"/>
    <Action ID="DispatchScheduledSteps"/>
    <Action ID="SelectSchedulableAction">
      <input_port name="LeadTimeSeconds" default="0"/>
    </Action>
    <Action ID="Wait">
      <input_port name="DelayMs" default="1000"/>
    </Action>
    <Action ID="WaitForMessage">
      <input_port name="ExpectedType" />
      <input_port name="ExpectedTypes" />
      <input_port name="ExpectedSender" />
      <input_port name="ExpectedTopic" />
      <input_port name="TimeoutSeconds" />
      <input_port name="ExpectedConversationId" />
    </Action>
    <Action ID="AwaitSkillResponse">
      <input_port name="ModuleId"/>
      <input_port name="TimeoutMs" default="200"/>
    </Action>
    <Action ID="ApplySkillResponse"/>
  </TreeNodesModel>
</root>
