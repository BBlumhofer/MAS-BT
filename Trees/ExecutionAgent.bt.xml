<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4" main_tree_to_execute="ActionExecutionTest">
  <BehaviorTree ID="ActionExecutionTest">
    <Sequence name="ExecutionAgent">
      <SubTree name="PreModuleInit" ID="PreModuleInit"/>
      <SubTree name="ModuleInitialization" ID="ModuleInitialization"/>
      <SubTree name="SkillExecution" ID="SkillExecution"/>
    </Sequence>
  </BehaviorTree>

  <!-- PreModuleInit: Verbindet MQTT und stellt Basis-Kommunikation sicher -->
  <BehaviorTree ID="PreModuleInit">
    <Sequence name="PreModuleInitSequence">
      <RetryUntilSuccess name="MqttConnectRetry" numAttempts="5" delayMs="2000">
        <ConnectToMessagingBroker 
          name="ConnectMqtt"
          BrokerHost="{config.MQTT.Broker}"
          BrokerPort="{config.MQTT.Port}"
          DefaultTopic="factory/agents/messages"
          TimeoutMs="10000"
          ClientId="{config.Agent.ModuleId}_ExecutionAgent" />
      </RetryUntilSuccess>
    </Sequence>
  </BehaviorTree>

  <!-- ModuleInitialization: OPC UA, Locking, Startup -->
  <BehaviorTree ID="ModuleInitialization">
    <Sequence name="ModuleInitializationSequence">
      <RetryUntilSuccess name="OpcUaConnectRetry" numAttempts="5" delayMs="3000">
        <ConnectToModule 
          name="ConnectOPC"
          Endpoint="{config.OPCUA.Endpoint}"
          TimeoutMs="30000" />
      </RetryUntilSuccess>

      <EnableStorageChangeMqtt name="EnableStorageOnChange" />

      <Sequence name="LockSequence">
        <LockResource 
          name="LockModule"
          ModuleName="{config.Agent.ModuleId}"
          ResourceId="{config.Agent.ModuleId}"
          TimeoutSeconds="30" />
        
        <CheckLockedState
          name="VerifyLocked"
          ModuleName="{config.Agent.ModuleId}"
          ExpectLocked="true" />
      </Sequence>

      <RetryUntilSuccess name="EnsureCoupledBeforeStartup" numAttempts="15" delayMs="2000">
        <EnsurePortsCoupled
          name="EnsurePortsCoupled"
          ModuleName="{config.Agent.ModuleId}"
          TimeoutSeconds="45" />
      </RetryUntilSuccess>

      <Sequence name="StartupSequence">
        <ExecuteSkill 
          name="ExecuteStartup"
          ModuleName="{config.Agent.ModuleId}"
          SkillName="StartupSkill"
          WaitForCompletion="false"
          TimeoutSeconds="60"
          ResetBeforeIfHalted="true" />
        
        <WaitForSkillState
          name="WaitForStartupRunning"
          ModuleName="{config.Agent.ModuleId}"
          SkillName="StartupSkill"
          TargetState="Running"
          TimeoutSeconds="30"
          PollIntervalMs="500"
          SendErrorOnTimeout="true" />
        
        <Fallback name="EnsureCoupledWhileRunning">
          <EnsurePortsCoupled
            name="EnsurePortsCoupledWhileRunning"
            ModuleName="{config.Agent.ModuleId}"
            TimeoutSeconds="45" />
          <AlwaysSuccess name="SkipCoupleRetry" />
        </Fallback>
        
        <SendLogMessage
          name="SendInitComplete"
          LogLevel="INFO"
          Message="Module initialization complete. Ready to accept skill requests."
          ModuleId="{config.Agent.ModuleId}"/>
      </Sequence>

      <UpdateInventory name="PublishInventoryAfterInit" 
               ModuleId="{config.Agent.ModuleId}" 
               PublishToMqtt="true"
               ForcePublish="true"/>
    </Sequence>
  </BehaviorTree>

  <!-- SkillExecution: Wartet auf Requests und fÃ¼hrt Actions aus -->
  <BehaviorTree ID="SkillExecution">
    <Sequence name="SkillExecutionSequence">
      <Repeat name="SkillRequestLoop" num_cycles="-1">
        
        <Sequence name="ProcessOneAction">
          <ReadMqttSkillRequest name="WaitForSkillRequest" 
                                ModuleId="{config.Agent.ModuleId}" 
                                TimeoutMs="100"/>
          
          <Fallback name="ActionExecution">
            <Sequence name="ExecuteValidAction">
              <Fallback name="CheckModuleAvailability">
                <CheckModuleState name="CheckNotExecuting"
                                 ModuleName="{MachineName}"
                                 ExpectedState="EXECUTING"
                                 InvertCheck="true"/>
                
                <ForceFailure name="StopAfterRefusalModuleBusy">
                  <Sequence name="SendRefusalModuleBusy">
                    <SendSkillResponse name="SendRefusal" 
                                      ModuleId="{config.Agent.ModuleId}" 
                                      ActionState="ERROR" 
                                      FrameType="refusal"/>
                  </Sequence>
                </ForceFailure>
              </Fallback>
              
              <CheckSkillPreconditions name="CheckSkillPreconditions" ModuleName="{MachineName}" />
              
              <SendSkillResponse name="SendConsent" 
                                ModuleId="{config.Agent.ModuleId}" 
                                ActionState="PLANNED" 
                                FrameType="consent"/>
              
              <SetModuleState name="SetExecuting"
                             ModuleName="{MachineName}"
                             State="EXECUTING"/>
              
              <SendSkillResponse name="SendRunning" 
                                ModuleId="{config.Agent.ModuleId}" 
                                ActionState="EXECUTING" 
                                FrameType="inform"/>
              
              <Fallback name="ExecuteWithFailureHandling">
                <Sequence name="ExecuteActionSkill">
                  <ExecuteSkill name="ExecuteMainSkill" 
                               ModuleName="{MachineName}" 
                               SkillName="{ActionTitle}" 
                               Parameters="{InputParameters}"
                               WaitForCompletion="true"
                               ResetAfterCompletion="false"
                               TimeoutSeconds="60"/>
                  
                  <MonitoringSkill name="MonitorFinalState" 
                                  ModuleName="{MachineName}" 
                                  SkillName="{ActionTitle}"/>
                  
                  <ResetSkill name="ResetAfterCompletion"
                             ModuleName="{MachineName}"
                             SkillName="{ActionTitle}"
                             TimeoutSeconds="10"/>
                </Sequence>
                
                <ForceFailure name="StopAfterFailure">
                  <Sequence name="SendFailureAfterError">
                    <SetModuleState name="SetError"
                                   ModuleName="{MachineName}"
                                   State="ERROR"/>
                    
                    <SendSkillResponse name="SendFailure" 
                                      ModuleId="{config.Agent.ModuleId}" 
                                      ActionState="ERROR" 
                                      FrameType="failure"/>
                  </Sequence>
                </ForceFailure>
              </Fallback>
              
              <UpdateInventory name="UpdateInventory" 
                               ModuleId="{config.Agent.ModuleId}" 
                               ModuleName="{config.Agent.ModuleId}"
                               PublishToMqtt="true"/>
              
              <SetModuleState name="SetDone"
                             ModuleName="{MachineName}"
                             State="DONE"/>
              
              <SendSkillResponse name="SendCompleted" 
                                ModuleId="{config.Agent.ModuleId}" 
                                ActionState="DONE" 
                                FrameType="inform"/>
              
              <SendStateMessage name="PublishState" 
                               ModuleId="{config.Agent.ModuleId}" 
                               IncludeModuleLocked="true" 
                               IncludeModuleReady="true"/>
            </Sequence>
            
            <Sequence name="FallbackCleanup">
              <SetModuleState name="ResetModuleState"
                             ModuleName="{MachineName}"
                             State="DONE"/>
              
              <AlwaysSuccess name="ContinueLoop"/>
            </Sequence>
            
          </Fallback>
          
        </Sequence>
        
      </Repeat>
    </Sequence>
  </BehaviorTree>
  
  <!-- TreeNodesModel for Groot2 Editor -->
  <TreeNodesModel>
    <Decorator ID="RetryUntilSuccess">
      <input_port name="numAttempts" default="-1"/>
      <input_port name="delayMs" default="1000"/>
    </Decorator>
    <Action ID="ConnectToMessagingBroker">
      <input_port name="BrokerHost"/>
      <input_port name="BrokerPort"/>
      <input_port name="DefaultTopic"/>
      <input_port name="TimeoutMs"/>
      <input_port name="ClientId"/>
    </Action>
    <Action ID="ConnectToModule">
      <input_port name="Endpoint"/>
      <input_port name="TimeoutMs"/>
    </Action>
    <Action ID="LockResource">
      <input_port name="ModuleName"/>
      <input_port name="ResourceId"/>
      <input_port name="TimeoutSeconds"/>
    </Action>
    <Action ID="EnsurePortsCoupled">
      <input_port name="ModuleName"/>
      <input_port name="TimeoutSeconds" default="30"/>
    </Action>
    <Condition ID="CheckLockedState">
      <input_port name="ModuleName"/>
      <input_port name="ExpectLocked"/>
    </Condition>
    <Action ID="ExecuteSkill">
      <input_port name="ModuleName"/>
      <input_port name="SkillName"/>
      <input_port name="Parameters"/>
      <input_port name="WaitForCompletion"/>
      <input_port name="TimeoutSeconds"/>
      <input_port name="ResetAfterCompletion" default="true"/>
      <input_port name="ResetBeforeIfHalted"/>
    </Action>
    <Action ID="WaitForSkillState">
      <input_port name="ModuleName"/>
      <input_port name="SkillName"/>
      <input_port name="TargetState" default="Running"/>
      <input_port name="TimeoutSeconds" default="60"/>
      <input_port name="PollIntervalMs" default="500"/>
      <input_port name="SendErrorOnTimeout" default="true"/>
    </Action>
    <Action ID="ReadMqttSkillRequest">
      <input_port name="ModuleId"/>
      <input_port name="TimeoutMs" default="100"/>
    </Action>
    <Action ID="CheckSkillPreconditions">
      <input_port name="ModuleName"/>
    </Action>
    <Action ID="SendSkillResponse">
      <input_port name="ModuleId"/>
      <input_port name="ActionState"/>
      <input_port name="FrameType"/>
    </Action>
    <Condition ID="CheckReadyState">
      <input_port name="ModuleName"/>
      <input_port name="ExpectedState" default="true"/>
    </Condition>
    <Condition ID="CheckErrorState">
      <input_port name="ModuleName"/>
      <input_port name="ExpectedHasError" default="false"/>
    </Condition>
    <Action ID="MonitoringSkill">
      <input_port name="ModuleName"/>
      <input_port name="SkillName"/>
    </Action>
    <Action ID="UpdateInventory">
      <input_port name="ModuleId"/>
      <input_port name="ModuleName"/>
      <input_port name="PublishToMqtt" default="true"/>
      <input_port name="ForcePublish" default="false"/>
    </Action>
    <Action ID="SendStateMessage">
      <input_port name="ModuleId"/>
      <input_port name="IncludeModuleLocked" default="true"/>
      <input_port name="IncludeModuleReady" default="true"/>
    </Action>
    <Action ID="SendLogMessage">
      <input_port name="LogLevel"/>
      <input_port name="Message"/>
      <input_port name="ModuleId"/>
    </Action>
    <Action ID="Wait">
      <input_port name="durationMs" default="1000"/>
    </Action>
    <Action ID="RetrySkill">
      <input_port name="ModuleName"/>
      <input_port name="SkillName"/>
      <input_port name="MaxAttempts" default="3"/>
      <input_port name="BackoffMs" default="1000"/>
    </Action>
    <Action ID="ResetSkill">
      <input_port name="ModuleName"/>
      <input_port name="SkillName"/>
      <input_port name="TimeoutSeconds" default="10"/>
    </Action>
    <Action ID="SetModuleState">
      <input_port name="ModuleName"/>
      <input_port name="State"/>
    </Action>
    <Action ID="EnableStorageChangeMqtt"/>
    <Condition ID="CheckModuleState">
      <input_port name="ModuleName"/>
      <input_port name="ExpectedState"/>
      <input_port name="InvertCheck" default="false"/>
    </Condition>
  </TreeNodesModel>
</root>
