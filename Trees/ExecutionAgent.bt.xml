<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4" main_tree_to_execute="ActionExecutionTest">
  <BehaviorTree ID="ActionExecutionTest">
    <Sequence name="ExecutionAgent">
      <SubTree ID="PreModuleInit"/>
      <SubTree ID="ModuleInitialization"/>
      <SubTree ID="SkillExecution"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="PreModuleInit">
    <Sequence name="PreModuleInitSequence">
      <RetryUntilSuccess name="MqttConnectRetry" numAttempts="5" delayMs="2000">
        <ConnectToMessagingBroker
          name="ConnectMqtt"
          BrokerHost="{config.MQTT.Broker}"
          BrokerPort="{config.MQTT.Port}"
          DefaultTopic="factory/agents/messages"
          TimeoutMs="10000"
          ClientId="{config.Agent.ModuleName}_ExecutionAgent" />
      </RetryUntilSuccess>
      <SetBlackboardValue name="SetExecutionRole" Key="AgentRole" Value="ExecutionAgent" />
      <SetBlackboardValue name="SetExecutionId" Key="AgentId" Value="{config.Agent.ModuleName}_Execution" />
      <RegisterSubHolon name="RegisterExecution" />
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="ModuleInitialization">
    <Sequence name="ModuleInitializationSequence">
      <RetryUntilSuccess name="OpcUaConnectRetry" numAttempts="5" delayMs="3000">
        <ConnectToModule
          name="ConnectOPC"
          Endpoint="{config.OPCUA.Endpoint}"
          TimeoutMs="30000" />
      </RetryUntilSuccess>

      <EnableStorageChangeMqtt name="EnableStorageOnChange" />

      <Sequence name="LockSequence">
        <LockResource
          name="LockModule"
          ModuleName="{config.Agent.ModuleName}"
          ResourceId="{config.Agent.ModuleName}"
          TimeoutSeconds="30" />

        <CheckLockedState
          name="VerifyLocked"
          ModuleName="{config.Agent.ModuleName}"
          ExpectLocked="true" />
      </Sequence>

      <RetryUntilSuccess name="EnsureCoupledBeforeStartup" numAttempts="15" delayMs="2000">
        <EnsurePortsCoupled
          name="EnsurePortsCoupled"
          ModuleName="{config.Agent.ModuleName}"
          TimeoutSeconds="45" />
      </RetryUntilSuccess>

      <Sequence name="StartupSequence">
        <ExecuteSkill
          name="ExecuteStartup"
          ModuleName="{config.Agent.ModuleName}"
          SkillName="StartupSkill"
          WaitForCompletion="false"
          TimeoutSeconds="60"
          ResetBeforeIfHalted="true" />

        <WaitForSkillState
          name="WaitForStartupRunning"
          ModuleName="{config.Agent.ModuleName}"
          SkillName="StartupSkill"
          TargetState="Running"
          TimeoutSeconds="30"
          PollIntervalMs="500"
          SendErrorOnTimeout="true" />

        <Fallback name="EnsureCoupledWhileRunning">
          <EnsurePortsCoupled
            name="EnsureCoupledWhileRunning"
            ModuleName="{config.Agent.ModuleName}"
            TimeoutSeconds="45" />
          <AlwaysSuccess name="SkipCoupleRetry" />
        </Fallback>

        <SendLogMessage
          name="SendInitComplete"
          LogLevel="INFO"
          Message="Module initialization complete. Ready to accept skill requests."
          ModuleId="{config.Agent.ModuleName}"/>
      </Sequence>

      <UpdateInventory name="PublishInventoryAfterInit"
               ModuleId="{config.Agent.ModuleName}"
               ModuleName="{config.Agent.ModuleName}"
               PublishToMqtt="true"
               ForcePublish="true"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="SkillExecution">
    <Parallel name="SkillExecutionParallel">
      <Repeat name="RegistrationHeartbeat" num_cycles="-1">
        <Sequence name="RegistrationBeat">
          <RegisterSubHolon name="RegisterExecutionHeartbeat" />
          <UpdateInventory name="HeartbeatInventory"
                           ModuleId="{config.Agent.ModuleName}"
                           ModuleName="{config.Agent.ModuleName}"
                           PublishToMqtt="true"
                           ForcePublish="true" />
          <PublishNeighbors name="HeartbeatNeighbors"
                            ModuleId="{config.Agent.ModuleName}"
                            ModuleName="{config.Agent.ModuleName}" />
          <Wait name="RegistrationWait" DelayMs="5000" />
        </Sequence>
      </Repeat>

      <Repeat name="SkillRequestLoop" num_cycles="-1">
        <Sequence name="ProcessOneAction">
          <ReadMqttSkillRequest name="WaitForSkillRequest"
                                ModuleId="{config.Agent.ModuleName}"
                                TimeoutMs="100"/>

          <Fallback name="ActionExecution">
            <Sequence name="ExecuteValidAction">
              <Fallback name="CheckModuleAvailability">
                <CheckModuleState name="CheckNotExecuting"
                                  ModuleName="{MachineName}"
                                  ExpectedState="EXECUTING"
                                  InvertCheck="true"/>

                <ForceFailure name="StopAfterRefusalModuleBusy">
                  <Sequence name="SendRefusalModuleBusy">
                    <SendSkillResponse name="SendRefusal"
                                       ModuleId="{config.Agent.ModuleName}"
                                       ActionState="ERROR"
                                       FrameType="refusal"/>
                  </Sequence>
                </ForceFailure>
              </Fallback>

              <CheckSkillPreconditions name="CheckSkillPreconditions" ModuleName="{MachineName}" />

              <SendSkillResponse name="SendConsent"
                                ModuleId="{config.Agent.ModuleName}"
                                ActionState="PLANNED"
                                FrameType="consent"/>

              <SetModuleState name="SetExecuting"
                              ModuleName="{MachineName}"
                              State="EXECUTING"/>

              <SendSkillResponse name="SendRunning"
                                ModuleId="{config.Agent.ModuleName}"
                                ActionState="EXECUTING"
                                FrameType="inform"/>

              <Fallback name="ExecuteWithFailureHandling">
                <Sequence name="ExecuteActionSkill">
                  <ExecuteSkill name="ExecuteMainSkill"
                                ModuleName="{MachineName}"
                                SkillName="{ActionTitle}"
                                Parameters="{InputParameters}"
                                WaitForCompletion="true"
                                ResetAfterCompletion="false"
                                TimeoutSeconds="60"/>

                  <MonitoringSkill name="MonitorFinalState"
                                   ModuleName="{MachineName}"
                                   SkillName="{ActionTitle}"/>

                  <ResetSkill name="ResetAfterCompletion"
                              ModuleName="{MachineName}"
                              SkillName="{ActionTitle}"
                              TimeoutSeconds="10"/>
                </Sequence>

                <ForceFailure name="StopAfterFailure">
                  <Sequence name="SendFailureAfterError">
                    <SetModuleState name="SetError"
                                    ModuleName="{MachineName}"
                                    State="ERROR"/>

                    <SendSkillResponse name="SendFailure"
                                      ModuleId="{config.Agent.ModuleName}"
                                      ActionState="ERROR"
                                      FrameType="failure"/>
                  </Sequence>
                </ForceFailure>
              </Fallback>

              <UpdateInventory name="UpdateInventory"
                               ModuleId="{config.Agent.ModuleName}"
                               ModuleName="{config.Agent.ModuleName}"
                               PublishToMqtt="true"/>

              <SetModuleState name="SetDone"
                              ModuleName="{MachineName}"
                              State="DONE"/>

              <SendSkillResponse name="SendCompleted"
                                ModuleId="{config.Agent.ModuleName}"
                                ActionState="DONE"
                                FrameType="inform"/>

              <SendStateMessage name="PublishState"
                                ModuleId="{config.Agent.ModuleName}"
                                IncludeModuleLocked="true"
                                IncludeModuleReady="true"/>
            </Sequence>

            <Sequence name="FallbackCleanup">
              <SetModuleState name="ResetModuleState"
                              ModuleName="{MachineName}"
                              State="READY"/>

              <SendSkillResponse name="SendCleanupRefusal"
                                ModuleId="{config.Agent.ModuleName}"
                                ActionState="ERROR"
                                FrameType="failure"/>
            </Sequence>
          </Fallback>

        </Sequence>
      </Repeat>
    </Parallel>
  </BehaviorTree>

  <TreeNodesModel>
    <Decorator ID="RetryUntilSuccess">
      <input_port name="numAttempts" default="-1"/>
      <input_port name="delayMs" default="1000"/>
    </Decorator>
    <Action ID="ConnectToMessagingBroker">
      <input_port name="BrokerHost"/>
      <input_port name="BrokerPort"/>
      <input_port name="DefaultTopic"/>
      <input_port name="TimeoutMs"/>
      <input_port name="ClientId"/>
    </Action>
    <Action ID="SetBlackboardValue">
      <input_port name="Key" />
      <input_port name="Value" />
      <input_port name="ValueType" default="string" />
    </Action>
    <Action ID="RegisterSubHolon" />
    <Action ID="ConnectToModule">
      <input_port name="Endpoint" />
      <input_port name="TimeoutMs" />
    </Action>
    <Action ID="EnableStorageChangeMqtt" />
    <Action ID="LockResource">
      <input_port name="ModuleName" />
      <input_port name="ResourceId" />
      <input_port name="TimeoutSeconds" />
    </Action>
    <Action ID="CheckLockedState">
      <input_port name="ModuleName" />
      <input_port name="ExpectLocked" />
    </Action>
    <Action ID="EnsurePortsCoupled">
      <input_port name="ModuleName" />
      <input_port name="TimeoutSeconds" />
    </Action>
    <Action ID="ExecuteSkill">
      <input_port name="ModuleName" />
      <input_port name="SkillName" />
      <input_port name="Parameters" />
      <input_port name="WaitForCompletion" />
      <input_port name="ResetAfterCompletion" />
      <input_port name="TimeoutSeconds" />
    </Action>
    <Action ID="WaitForSkillState">
      <input_port name="ModuleName" />
      <input_port name="SkillName" />
      <input_port name="TargetState" />
      <input_port name="TimeoutSeconds" />
      <input_port name="PollIntervalMs" />
      <input_port name="SendErrorOnTimeout" />
    </Action>
    <Action ID="AlwaysSuccess" />
    <Action ID="SendLogMessage">
      <input_port name="LogLevel" />
      <input_port name="Message" />
      <input_port name="ModuleId" />
    </Action>
    <Action ID="UpdateInventory">
      <input_port name="ModuleId" />
      <input_port name="ModuleName" />
      <input_port name="PublishToMqtt" />
      <input_port name="ForcePublish" />
    </Action>
    <Action ID="PublishNeighbors">
      <input_port name="ModuleId" />
      <input_port name="ModuleName" />
    </Action>
    <Action ID="Wait">
      <input_port name="DelayMs" default="1000" />
    </Action>
    <Action ID="ReadMqttSkillRequest">
      <input_port name="ModuleId" />
      <input_port name="TimeoutMs" />
    </Action>
    <Action ID="CheckModuleState">
      <input_port name="ModuleName" />
      <input_port name="ExpectedState" />
      <input_port name="InvertCheck" />
    </Action>
    <Action ID="ForceFailure" />
    <Action ID="SendSkillResponse">
      <input_port name="ModuleId" />
      <input_port name="ActionState" />
      <input_port name="FrameType" />
    </Action>
    <Action ID="CheckSkillPreconditions">
      <input_port name="ModuleName" />
    </Action>
    <Action ID="SetModuleState">
      <input_port name="ModuleName" />
      <input_port name="State" />
    </Action>
    <Action ID="MonitoringSkill">
      <input_port name="ModuleName" />
      <input_port name="SkillName" />
    </Action>
    <Action ID="ResetSkill">
      <input_port name="ModuleName" />
      <input_port name="SkillName" />
      <input_port name="TimeoutSeconds" />
    </Action>
    <Action ID="SendStateMessage">
      <input_port name="ModuleId" />
      <input_port name="IncludeModuleLocked" />
      <input_port name="IncludeModuleReady" />
    </Action>
  </TreeNodesModel>
</root>
